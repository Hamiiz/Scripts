{
    "manifest_version": 3,
    "name": "CRM Disposition Panel",
    "version": "1.0",
    "description": "Enhanced CRM disposition helper panel",
    "permissions": [
        "activeTab",
        "storage",
        "scripting"
    ],
    "host_permissions": [
        "*://69.10.47.54/*",
        "*://proxy2.alliancedialer.com/*"
    ],
    "action": {
        "default_popup": "popup.html",
        "default_title": "Open CRM Disposition Panel"
    },
    "content_scripts": [{
        "matches": [
            "*://69.10.47.54/*",
            "*://proxy2.alliancedialer.com/*"
        ],
        "js": ["content.js"],
        "run_at": "document_end"
    }],
    "icons": {
        "16": "icon16.png",
        "48": "icon48.png",
        "128": "icon128.png"
    }
}



{
    "manifest_version": 3,
    "name": "CRM Disposition Panel",
    "version": "1.0",
    "description": "Enhanced CRM disposition helper panel",
    "permissions": [
        "activeTab",
        "storage",
        "scripting"
    ],
    "host_permissions": [
        "*://69.10.47.54/*",
        "*://proxy2.alliancedialer.com/*"
    ],
    "action": {
        "default_popup": "popup.html",
        "default_title": "Open CRM Disposition Panel"
    },
    "content_scripts": [{
        "matches": [
            "*://69.10.47.54/*",
            "*://proxy2.alliancedialer.com/*"
        ],
        "js": ["content.js"],
        "run_at": "document_end"
    }],
    "icons": {
        "16": "icon16.png",
        "48": "icon48.png",
        "128": "icon128.png"
    }
}<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body {
            width: 350px;
            height: 600px;
            margin: 0;
            padding: 0;
            font-family: 'Inter', Arial, sans-serif;
            background: #f8f9fa;
        }

        .header {
            background: linear-gradient(135deg, #2e7d32, #43a047);
            color: white;
            padding: 12px 15px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .search-container {
            padding: 10px 15px;
            background: white;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .button-container {
            padding: 10px 15px;
            overflow-y: auto;
            height: calc(100vh - 180px);
        }

        .dispo-group {
            margin-bottom: 15px;
        }

        .group-label {
            font-weight: 600;
            color: #2e7d32;
            margin: 8px 0 5px 0;
            padding-left: 8px;
            border-left: 3px solid #2e7d32;
            font-size: 12px;
        }

        .dispo-button {
            width: 100%;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 3px 0;
            cursor: pointer;
            text-align: left;
            font-size: 11px;
            transition: all 0.2s ease;
        }

        .dispo-button:hover {
            background: #e8f5e9;
            border-color: #4CAF50;
            transform: translateY(-1px);
        }

        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .action-button {
            background: #388e3c;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 5px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: background 0.2s ease;
        }

        .action-button:hover {
            background: #2e7d32;
        }

        .action-button.save {
            background: #1976d2;
        }

        .action-button.save:hover {
            background: #1565c0;
        }

        .hidden {
            display: none !important;
        }

        .no-results {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="header">
        CRM Disposition Panel
    </div>

    <div class="search-container">
        <input type="text" class="search-input" placeholder="ðŸ” Search dispositions..." id="searchInput">
    </div>

    <div class="button-container" id="buttonContainer">
        <!-- Disposition buttons will be loaded here -->
    </div>

    <div class="action-buttons">
        <button class="action-button" id="saveBtn">ðŸ’¾ Save</button>
        <button class="action-button" id="finishBtn">ðŸ“ž Finish</button>
        <button class="action-button" id="machineBtn">ðŸ¤– Ans Mach</button>
        <button class="action-button" id="faxBtn">ðŸ“  Fax</button>
        <button class="action-button" id="duplicateBtn">âŽ˜ Duplicate</button>
        <button class="action-button save" id="quickSaveBtn">âš¡ Quick Save</button>
    </div>

    <script src="popup.js"></script>
</body>
</html>


// Disposition data - same as your original script
const DISPOSITIONS = {
    "No answer": { value: 12, notes: ["continuous ringing", "dead air", "call dropped"] },
    "Machine answer": { value: 11, notes: ["Quick Disposition"] },
    "Unidentified Hang Up": { value: 105, notes: ["Tp hu after saying hello", "Tp hung up after hearing the funds name", "TP hung up before reason for the call", "TP hung up before confirming the address"] },
    "Left Message With Third Party": { value: 9, notes: ["left message without tfn", "tp said not interested and hu", "left toll-free number with TP", "TP hung up after hearing the reason"] },
    "Call Intercept": { value: 2, notes: ["Google/Virtual Assistant", "Ads", "Nomo Robo", "soundboard", "Smart Call Blocker", "Number not accepting calls", "number has been blocked"] },
    "Operator Tritone": { value: 14, notes: ["number not in service", "number has been disconnected"] },
    "DNC by tp": { value: 119, notes: ["TP said 'do not call me'", "TP requested removal from list"] },
    "DNC by SH": { value: 4, notes: ["SH asked not to be called", "sh requested to be removed from the list"] },
    "Hang Up by contact": { value: 6, notes: ["sh hu after hearing the funds name", "sh hu before hearing the reason of the call"] },
    "Undecided sh not sure": { value: 27, notes: ["requested call back", "sh is busy", "sh hu after hearing the reason of the call"] },
    "Not interested": { value: 13, notes: ["sh said they are not interested in voting", "Doesn't want to vote on phone"] },
    "Undecided sh waiting for an fa": { value: 26, notes: ["waiting for FA", "SH waiting for significant other"] },
    "Will Vote": { value: 30, notes: ["will return the proxy", "sh will vote online"] },
    "Wrong Number": { value: 31, notes: ["address incorrect"] }
};

const IB_DISPOSITIONS = {
    "Sh called in": { value: 20, notes: ["SH Called in"] },
    "Endeavour": { value: 61, notes: ["endeavour"] },
    "Directory": { value: 40, notes: ["directory assistance"] }
};

// Initialize the popup
document.addEventListener('DOMContentLoaded', function() {
    populateDispositions();
    setupEventListeners();
    loadSearchState();
});

function populateDispositions() {
    const container = document.getElementById('buttonContainer');
    container.innerHTML = '';

    // Add main dispositions
    Object.entries(DISPOSITIONS).forEach(([dispoName, dispoData]) => {
        addDispoGroup(container, dispoName, dispoData);
    });

    // Add IB dispositions
    Object.entries(IB_DISPOSITIONS).forEach(([dispoName, dispoData]) => {
        addDispoGroup(container, dispoName, dispoData, true);
    });
}

function addDispoGroup(container, dispoName, dispoData, isIB = false) {
    const groupDiv = document.createElement('div');
    groupDiv.className = 'dispo-group';
    groupDiv.dataset.groupName = dispoName.toLowerCase();

    const label = document.createElement('div');
    label.className = 'group-label';
    label.textContent = isIB ? `ðŸ“ž ${dispoName}` : dispoName;
    groupDiv.appendChild(label);

    dispoData.notes.forEach(note => {
        const button = document.createElement('button');
        button.className = 'dispo-button';
        button.textContent = note;
        button.dataset.dispoValue = dispoData.value;
        button.dataset.dispoNote = note;
        button.dataset.dispoName = dispoName;
        
        button.addEventListener('click', function() {
            applyDisposition(dispoData.value, note);
            highlightButton(button);
        });
        
        groupDiv.appendChild(button);
    });

    container.appendChild(groupDiv);
}

function setupEventListeners() {
    // Search functionality
    const searchInput = document.getElementById('searchInput');
    searchInput.addEventListener('input', function() {
        filterDispositions(this.value.toLowerCase());
        saveSearchState(this.value);
    });

    // Action buttons
    document.getElementById('saveBtn').addEventListener('click', () => {
        sendActionToContentScript('save');
    });

    document.getElementById('finishBtn').addEventListener('click', () => {
        sendActionToContentScript('finish');
    });

    document.getElementById('machineBtn').addEventListener('click', () => {
        sendActionToContentScript('machine');
    });

    document.getElementById('faxBtn').addEventListener('click', () => {
        sendActionToContentScript('fax');
    });

    document.getElementById('duplicateBtn').addEventListener('click', () => {
        sendActionToContentScript('duplicate');
    });

    document.getElementById('quickSaveBtn').addEventListener('click', () => {
        sendActionToContentScript('quickSave');
    });
}

function filterDispositions(searchTerm) {
    const groups = document.querySelectorAll('.dispo-group');
    let hasVisibleResults = false;

    groups.forEach(group => {
        const buttons = group.querySelectorAll('.dispo-button');
        let groupHasVisibleButtons = false;

        buttons.forEach(button => {
            const matches = button.textContent.toLowerCase().includes(searchTerm) || 
                           group.dataset.groupName.includes(searchTerm);
            
            button.style.display = matches ? 'block' : 'none';
            if (matches) groupHasVisibleButtons = true;
        });

        group.style.display = groupHasVisibleButtons ? 'block' : 'none';
        if (groupHasVisibleButtons) hasVisibleResults = true;
    });

    // Show no results message
    let noResults = document.getElementById('noResults');
    if (!hasVisibleResults && searchTerm) {
        if (!noResults) {
            noResults = document.createElement('div');
            noResults.id = 'noResults';
            noResults.className = 'no-results';
            noResults.textContent = 'No dispositions found';
            document.getElementById('buttonContainer').appendChild(noResults);
        }
    } else if (noResults) {
        noResults.remove();
    }
}

function applyDisposition(value, note) {
    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        chrome.tabs.sendMessage(tabs[0].id, {
            action: 'applyDisposition',
            value: value,
            note: note
        });
    });
}

function sendActionToContentScript(action) {
    chrome.tabs.query({active: true, currentWindow: true}, function(tabs) {
        chrome.tabs.sendMessage(tabs[0].id, {
            action: action
        });
    });
}

function highlightButton(button) {
    // Remove highlight from all buttons
    document.querySelectorAll('.dispo-button').forEach(btn => {
        btn.style.background = '';
        btn.style.borderColor = '';
    });
    
    // Highlight clicked button
    button.style.background = '#e8f5e9';
    button.style.borderColor = '#4CAF50';
}

function saveSearchState(searchTerm) {
    chrome.storage.local.set({ lastSearch: searchTerm });
}

function loadSearchState() {
    chrome.storage.local.get(['lastSearch'], function(result) {
        if (result.lastSearch) {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = result.lastSearch;
            filterDispositions(result.lastSearch);
        }
    });
}





// Content script that runs on the CRM pages
console.log('CRM Disposition Panel Content Script Loaded');

const fieldIDs = {
    disposition: 'dialer_disposition',
    note: 'dialer_notes',
    saveButton: 'save_disposition',
    finishButton: 'end_call'
};

// Listen for messages from the popup
chrome.runtime.onMessage.addListener(function(request, sender, sendResponse) {
    console.log('Message received in content script:', request);
    
    switch(request.action) {
        case 'applyDisposition':
            applyDisposition(request.value, request.note);
            break;
            
        case 'save':
            safeClick(['save_disposition_all', fieldIDs.saveButton]);
            break;
            
        case 'finish':
            safeClick([fieldIDs.finishButton]);
            break;
            
        case 'machine':
            safeClick(['end_call_am']);
            break;
            
        case 'fax':
            safeClick(['end_call_fm']);
            break;
            
        case 'duplicate':
            duplicateTab();
            break;
            
        case 'quickSave':
            quickSave();
            break;
    }
    
    return true;
});

function applyDisposition(value, note) {
    const dispoField = document.getElementById(fieldIDs.disposition);
    const noteField = document.getElementById(fieldIDs.note);
    
    if (dispoField) {
        dispoField.value = value;
        // Trigger change event in case the page listens for it
        dispoField.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    if (noteField) {
        noteField.value = note;
        noteField.dispatchEvent(new Event('change', { bubbles: true }));
    }
    
    console.log(`Applied disposition: ${value}, note: ${note}`);
}

function safeClick(idList) {
    for (let id of idList) {
        const element = document.getElementById(id);
        if (element && !element.disabled) {
            console.log(`Clicking element: ${id}`);
            element.click();
            return true;
        }
    }
    console.warn('No clickable element found for:', idList);
    return false;
}

function duplicateTab() {
    const currentUrl = window.location.href;
    window.open(currentUrl, '_blank');
    
    // Transfer any necessary data
    const transferData = {
        referrer: window.location.href,
        timestamp: Date.now()
    };
    sessionStorage.setItem('tabDuplicateData', JSON.stringify(transferData));
}

function quickSave() {
    // First try to apply a default disposition if fields are empty
    const dispoField = document.getElementById(fieldIDs.disposition);
    const noteField = document.getElementById(fieldIDs.note);
    
    if (dispoField && dispoField.value === '' && noteField && noteField.value === '') {
        // Apply a default quick disposition
        applyDisposition(11, "Quick Disposition");
    }
    
    // Then save
    setTimeout(() => {
        safeClick(['save_disposition_all', fieldIDs.saveButton]);
    }, 100);
}

// Add a small indicator to show the extension is active
function addActiveIndicator() {
    const indicator = document.createElement('div');
    indicator.style.cssText = `
        position: fixed;
        top: 10px;
        right: 10px;
        background: #4CAF50;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 12px;
        z-index: 10000;
        pointer-events: none;
    `;
    indicator.textContent = 'CRM Panel Active';
    document.body.appendChild(indicator);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
        }
    }, 3000);
}

// Initialize when page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addActiveIndicator);
} else {
    addActiveIndicator();
}